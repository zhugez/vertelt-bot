name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux (${{ matrix.compiler }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libcurl4-openssl-dev gcc g++ clang

      - name: Configure compiler
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> "$GITHUB_ENV"
            echo "CXX=g++" >> "$GITHUB_ENV"
          else
            echo "CC=clang" >> "$GITHUB_ENV"
            echo "CXX=clang++" >> "$GITHUB_ENV"
          fi

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Install to staging prefix
        run: cmake --install build --prefix staging

      - name: Package
        run: |
          artifact="vertel-${{ github.ref_name }}-linux-x86_64-${{ matrix.compiler }}.tar.gz"
          cp README.md LICENSE CHANGELOG.md staging/
          tar -czf "$artifact" -C staging .
          echo "ARTIFACT=$artifact" >> "$GITHUB_ENV"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ env.ARTIFACT }}

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ARTIFACT }}
          prerelease: true
          generate_release_notes: true

  build-windows:
    name: Build Windows (MSVC ${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            triplet: x64-windows-static
            msvc_arch: x64
          - arch: x86
            triplet: x86-windows-static
            msvc_arch: Win32
    env:
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}
    steps:
      - uses: actions/checkout@v4

      - name: Install curl via vcpkg
        run: vcpkg install curl:${{ matrix.triplet }}

      - name: Configure
        run: >
          cmake -S . -B build -A ${{ matrix.msvc_arch }}
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }}

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Test
        run: ctest --test-dir build --build-config Release --output-on-failure

      - name: Assemble Visual Studio SDK package
        shell: pwsh
        run: |
          $sdk = "sdk"

          # Libraries (VerTel + vcpkg-built curl)
          New-Item -ItemType Directory -Force -Path "$sdk/lib/${{ matrix.arch }}"
          Copy-Item build/Release/*.lib -Destination "$sdk/lib/${{ matrix.arch }}/"
          # Copy vcpkg-built static curl lib so consumers don't need vcpkg
          $vcpkgLibDir = "$env:VCPKG_INSTALLATION_ROOT/installed/${{ matrix.triplet }}/lib"
          if (Test-Path "$vcpkgLibDir/libcurl.lib") {
            Copy-Item "$vcpkgLibDir/libcurl.lib" -Destination "$sdk/lib/${{ matrix.arch }}/"
          }
          if (Test-Path "$vcpkgLibDir/zlib.lib") {
            Copy-Item "$vcpkgLibDir/zlib.lib" -Destination "$sdk/lib/${{ matrix.arch }}/"
          }

          # Headers (public API)
          Copy-Item -Recurse include/vertel "$sdk/include/vertel"
          # Generated version header
          Copy-Item build/include/vertel/vertel_version.h "$sdk/include/vertel/"
          # Third-party headers needed at compile time
          Copy-Item -Recurse third_party/nlohmann "$sdk/include/nlohmann"

          # Docs
          Copy-Item README.md, LICENSE, CHANGELOG.md -Destination "$sdk/"

          # Visual Studio property sheet for easy integration
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
            <PropertyGroup Label="UserMacros">
              <VERTEL_ROOT>`$(MSBuildThisFileDirectory)</VERTEL_ROOT>
            </PropertyGroup>
            <ItemDefinitionGroup>
              <ClCompile>
                <AdditionalIncludeDirectories>`$(VERTEL_ROOT)include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
                <PreprocessorDefinitions>VERTEL_HAS_LIBCURL=1;%(PreprocessorDefinitions)</PreprocessorDefinitions>
                <LanguageStandard>stdcpp20</LanguageStandard>
              </ClCompile>
              <Link>
                <AdditionalLibraryDirectories>`$(VERTEL_ROOT)lib/${{ matrix.arch }};%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
                <AdditionalDependencies>vertel_core.lib;vertel_runtime.lib;vertel_adapters.lib;vertel_platform.lib;libcurl.lib;zlib.lib;ws2_32.lib;Crypt32.lib;Wldap32.lib;Normaliz.lib;%(AdditionalDependencies)</AdditionalDependencies>
              </Link>
            </ItemDefinitionGroup>
          </Project>
          "@ | Out-File -Encoding utf8 "$sdk/vertel.props"

          # Package
          $artifact = "vertel-${{ github.ref_name }}-windows-${{ matrix.arch }}-msvc.zip"
          Compress-Archive -Path "$sdk/*" -DestinationPath $artifact
          echo "ARTIFACT=$artifact" >> $env:GITHUB_ENV

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ env.ARTIFACT }}

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ARTIFACT }}
          prerelease: true
          generate_release_notes: true
